# java-shareit. REST API для сервиса шейринга вещей.

 ## Краткое описание
Приложение представляет собой REST-API для сервиса шейринга, т.е. сервиса, позволяющего пользователям размещать 
свои вещи на одной площадке и предоставлять их во временное пользование друг другу. Реализованы CRUD операции с 
пользователями и вещами, возможность оставлять запросы на бронирование вещи и оставлять комментарии после бронирования,
возможность одному пользователю оставлять запрос, содержащий описание нужной вещи, на основании которого другой 
пользователь может добавить соответствующую вещь.
## Микросервисы
Приложение разбито на два микросервиса - gateway и server. В gateway находится вся логика валидации запросов. В случае успешной валидации gateway формирует запрос к server и возвращает полученный ответ.

 ## Запуск
  - mvn clean package
  - docker-compose up

Команды выполняются из корневой директории приложения. Создаются 3 контейнера - 
gateway:8080, server:9090 и db:6541. Gateway - микросервис для валидации запросов. 
Server - основная функциональность приложения. DB - база данных, PostgreSQL 13.7. 
Образы для gateway и server создаются из соответствующих Dockerfile (amazoncorretto:11-alpine-jdk + запуск jar приложения). 
Образ PostgreSQL - postgres:13.7-alpine.

## Тестирование
Для тестирования приложения используются модульные, интеграционные и BDD тесты. Модульные и интеграционные тесты покрывают код на 96%. 
Для BDD тестов используется Postman.
 ## Эндпоинты
 1) __Users__ - пользователи:
    - __GET /users__ - получение JSON списка всех пользователей в виде:
          
          {"id": ID пользователя,
           "name": "Имя пользователя",
           "email":"E-mail пользователя"}
    - __GET /users/{userId}__ - получение JSON пользователя по ID
    - __POST /users__ - добавление нового пользователя. Тело запроса - JSON вида: 
    
          {"name": "Имя пользователя", 
           "email":"E-mail пользователя"}
       Ни один из параметров не может быть пустым. email должен быть корректным. 
    - __PATCH /users/{userId}__ - обновление пользователя. Тело запроса - JSON, как при добавлении. При этом один или 
    несколько параметров могут быть пустыми.
    - __DELETE /users/{userId}__ - удаление пользователя по ID
    
  2) __Items__ - вещи для шейринга. В запросах используется заголовок "X-Sharer-User-Id" = ID пользователя. Значения по-умолчанию from = 0, size = 10:
     - __GET /items?from={from}&size={size}__ - вывод size вещей, начиная с from, которые принадлежат пользователю в виде:
       
             {"id": ID вещи, 
              "name": "Название вещи", 
              "description": "Описание", 
              "available": Доступность - true, false, 
              "comments": [{"id": ID комментария, 
                            "text": "Текст комментария", 
                            "authorName": "Имя автора", 
                            "created": "Дата создания"}], 
              "reqiestId": ID запроса по которому создана вещь, либо null,
              "lastBooking": {"id": ID последнего бронирования вещи,
                              "start": "Дата начала",
                              "end": "Дата окончания",
                              "bookerId": ID бронирующего пользователя}, 
               "nextBooking": {"id": ID следующего бронирования вещи,
                              "start": "Дата начала",
                              "end": "Дата окончания",
                              "bookerId": ID бронирующего пользователя}}
     - __GET /items/{itemId}__ - вывод вещи по ID. Запросить вывод может любой пользователь. При этом для владельца используется формат с последним и следующим бронированиями, а для остальных пользователей без, т.е.:

            {"id": ID вещи,
             "name": "Название вещи",
             "description": "Описание",
             "available": Доступность - true, false,
             "comments": [{"id": ID комментария,
             "text": "Текст комментария",
             "authorName": "Имя автора",
             "created": "Дата создания"}],
             "reqiestId": ID запроса по которому создана вещь, либо null}
     - __POST /items__ - добавление новой вещи. Тело запроса JSON:

            {"name": "Название вещи",
             "description": "Описание",
             "available": Доступность - true, false,
             "reqiestId": ID запроса по которому создана вещь, либо null}
       Название, описание и доступность вещи не могут быть пустыми.
     - __PATCH /items/{itemId}__ - обновление вещи по ID. Тело запроса - JSON, как при добавлении, поля могут быть пустыми. Обновить может только владелец. Обновить можно поля - название, описание, доступность. 
     - __GET /items/search?text={text}&from={from}&size={size}__ - поиск вещей, содержащих text в названии или описании. Вывод size вещей, начиная с from.
     - __POST /items/{itemId}/comment__ - добавление комментария к вещи. Оставить комментарий может только пользователь, бронировавший вещь в прошлом. Тело запроса JSON вида:
        
           {"text": "Текст комментария"}

  3) __Bookings__ - бронирования вещей. В запросах используется заголовок "X-Sharer-User-Id" = ID пользователя. Значения по-умолчанию from = 0, size = 10:
     - __GET /bookings?state={state}&from={from}&size={size}__ - получение всех бронирований текущего пользователя. Выводится size бронирований, начиная с from. Возможные значения state: ALL - все бронирования, CURRENT - текущие, PAST - завершенные, FUTURE - будущие, WAITING - ожидающие подтверждения, REJECTED - отклоненные. Бронирования возвращаются отсортированные по дате от более новых к старым. Возвращается массив JSON вида: 
           
           {"id": ID бронирования, 
           "start": "Время начала", 
           "end": "Время окончания, 
           "item": {"id": ID вещи, 
                    "name": "Название", 
                    "description": "Описание", 
                    "available": Доступность}, 
           "booker": {"id": ID бронирующего, 
                      "name": "Имя", 
                      "email": "E-mail"}, 
           "status": "Статус бронирования"}
     - __GET /bookings/owner?state={state}&from={from}&size={size}__ - получение всех бронирований на вещи текущего пользователя. Параметры совпадают с запросом на получение всех бронирований пользователя.
     - __GET /bookings/{bookingId}__ - получение бронирования по ID. Может быть выполнено только бронирующим пользователем, либо владельцем вещи.
     - __POST /bookings__ - добавление нового запроса на бронирование. Может быть создан любым пользователем, а затем подтвержден владельцем вещи. JSON запроса: 
             
           {"start": "Время начала бронирования", 
            "end": "Время окончания бронирования, 
            "itemId": ID бронируемой вещи}
       Время начала должно быть в будущем. Время окончания не может быть раньше времени начала.
     - __PATCH /bookings/{bookingId}?approved={approved}__ - подтверждение, либо отказ на бронирование от владельца вещи. approved может быть true либо false.

  4) __Requests__ - запросы на вещи. В запросах используется заголовок "X-Sharer-User-Id" = ID пользователя. Значения по-умолчанию from = 0, size = 10:
     - __GET /requests__ - получить список запросов пользователя. Возвращается массив JSON вида: 
        
           {"id": ID запроса, 
            "description": "Описание", 
            "created": "Дата создания", 
            "items": [{"id": ID вещи, 
                       "name": "Название", 
                       "ownerId": ID владельца,
                       "description": "Описание",
                       "requestId": ID запроса, по которому добавлена вещ,
                       "available": Доступность вещи}]}
     - __GET /requests/all?from={from}&size={size}__ - получение всех запросов, кроме запросов пользователя. Выводится size запросов, начиная с from. 
     - __GET /requests/{requestId}__ - получение запроса по ID.
     - __POST /requests__ - добавление нового запроса. JSON тело вида:
       
           {"description": "Описание запроса"}
       Описание не может быть пустым.

## База данных

В качестве БД используется PostgreSQL. Для тестов - H2. 
![ER-диаграмма](/png/Shareit-ER.png "ER-диаграмма")
